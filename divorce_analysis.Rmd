---
title: "Divorce Analysis"
author: "Celeste Chen and Sarah Unbehaun"
date: "May 8, 2017"
output:
  pdf_document: default
  ---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(gridExtra)
```

```{r data, include=FALSE}
load("GSSdivorce.rda")
```

### Step One: Explore and Modify Data
```{r missing, include=FALSE}
#Restrict 
GSS.divorce <- GSS.divorce[GSS.divorce$year>=1996, ]
GSS.divorce <- GSS.divorce[GSS.divorce$marital=="MARRIED" | GSS.divorce$marital=="DIVORCED" | GSS.divorce$marital=="SEPARATED", ]
GSS.divorce$marital <- factor(GSS.divorce$marital)

GSS.divorce$marital2 <- "married"
GSS.divorce$marital2 [GSS.divorce$marital == "SEPARATED"] <- "split"
GSS.divorce$marital2 [GSS.divorce$marital == "DIVORCED"] <- "split"
GSS.divorce$marital2 [is.na(GSS.divorce$marital) ==T] <- NA
GSS.divorce$marital2 <- factor(GSS.divorce$marital2)
GSSnew <- GSS.divorce[!is.na(GSS.divorce$marital2),]
summary(GSSnew$marital2)
GSSnew$sizecat <- NA
GSSnew$sizecat [GSSnew$size < 10] <- "rural"
GSSnew$sizecat [GSSnew$size >=10 & GSSnew$size <= 99] <- "small"
GSSnew$sizecat [GSSnew$size >=100 & GSSnew$size <= 999] <- "medium"
GSSnew$sizecat [GSSnew$size >=1000 & GSSnew$size <= 9999] <- "large"
GSSnew$sizecat <- factor(GSSnew$sizecat)
GSSnew$educcat <-cut(GSSnew$educ, seq(0,20,4))
```

### Step Two: Visually check distributions of variable responses

```{r visuals, echo=FALSE}
library(ggplot2)
library(plyr)

##Opinion on Premarital Sex 
#Married vs Divorced vs Separated vs Other
tab <- as.data.frame(table(GSSnew$marital, GSSnew$premarsx))
colnames(tab) <- c("status", "premarital", "count")
pie_1a <- ggplot(tab, aes(status, premarital)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Opinion on premarital sex?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$premarsx))
colnames(tab) <- c("status", "premarital", "count")
pie_1b <- ggplot(tab, aes(status, premarital)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Opinion on premarital sex?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

##Opinion on Pornography Laws
tab <- as.data.frame(table(GSSnew$marital, GSSnew$pornlaw))
colnames(tab) <- c("status", "porn", "count")
pie_2a <- ggplot(tab, aes(status, porn)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Opinion on pornography regulation?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$pornlaw))
colnames(tab) <- c("status", "porn", "count")
pie_2b <- ggplot(tab, aes(status, porn)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Opinion on pornography regulation?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

##Opinion on Extramarital Sex 
tab <- as.data.frame(table(GSSnew$marital, GSSnew$xmarsex))
colnames(tab) <- c("status", "exmar", "count")
pie_3a <- ggplot(tab, aes(status, exmar)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Opinion on extramarital sex?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$xmarsex))
colnames(tab) <- c("status", "exmar", "count")
pie_3b <- ggplot(tab, aes(status, exmar)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Opinion on extramarital sex?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

##Party Identification 
tab <- as.data.frame(table(GSSnew$marital, GSSnew$partyid))
colnames(tab) <- c("status", "party", "count")
pie_4a <- ggplot(tab, aes(status, party)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Party identification?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$partyid))
colnames(tab) <- c("status", "party", "count")
pie_4b <- ggplot(tab, aes(status, party)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Party identification?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

##How happy are you? 
tab <- as.data.frame(table(GSSnew$marital, GSSnew$happy))
colnames(tab) <- c("status", "happy", "count")
pie_5a <- ggplot(tab, aes(status, happy)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("How happy are you?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$happy))
colnames(tab) <- c("status", "happy", "count")
pie_5b <- ggplot(tab, aes(status, happy)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("How happy are you?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

##Fundamentalism of Religion 
tab <- as.data.frame(table(GSSnew$marital, GSSnew$fund))
colnames(tab) <- c("status", "fund", "count")
pie_6a <- ggplot(tab, aes(status, fund)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Fundamentalism of religion?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$fund))
colnames(tab) <- c("status", "fund", "count")
pie_6b <- ggplot(tab, aes(status, fund)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Fundamentalism of religion?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

##Self-Identified Class
tab <- as.data.frame(table(GSSnew$marital, GSSnew$class))
colnames(tab) <- c("status", "class", "count")
pie_7a <- ggplot(tab, aes(status, class)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Self-identified class?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$class))
colnames(tab) <- c("status", "class", "count")
pie_7b <- ggplot(tab, aes(status, class)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Self-identified class?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

##Work Status
tab <- as.data.frame(table(GSSnew$marital, GSSnew$wrkstat))
colnames(tab) <- c("status", "work", "count")
pie_8a <- ggplot(tab, aes(status, work)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Work status?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$wrkstat))
colnames(tab) <- c("status", "work", "count")
pie_8b <- ggplot(tab, aes(status, work)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Work status?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)


##Years of Education 
tab <- as.data.frame(table(GSSnew$marital, GSSnew$educ))
colnames(tab) <- c("status", "edu", "count")
pie_9a <- ggplot(tab, aes(status, edu)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Years of education?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$educ))
colnames(tab) <- c("status", "edu", "count")
pie_9b <- ggplot(tab, aes(status, edu)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Years of education?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

      ###Histogram
        EducGraph2 <- ggplot(GSSnew, aes(x= educ,  group=marital2)) + 
            geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") +
            geom_text(aes( label = scales::percent(..prop..),
                           y= ..prop.. ), stat= "count", vjust = -.5) +
            labs(y = "Percent", fill="educ") +
            facet_grid(~marital2) +
            scale_y_continuous(labels = scales::percent)

##Children 
tab <- as.data.frame(table(GSSnew$marital, GSSnew$childs))
colnames(tab) <- c("status", "child", "count")
pie_10a <- ggplot(tab, aes(status, child)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Children?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$childs))
colnames(tab) <- c("status", "child", "count")
pie_10b <- ggplot(tab, aes(status, child)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Children?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)


#Sex Education in Schools
tab <- as.data.frame(table(GSSnew$marital, GSSnew$sexeduc))
colnames(tab) <- c("status", "sexed", "count")
pie_11a <- ggplot(tab, aes(status, sexed)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Sex education in schools?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$sexeduc))
colnames(tab) <- c("status", "sexed", "count")
pie_11b <- ggplot(tab, aes(status, sexed)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Sex education in schools?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

       SexEducGraph2 <- ggplot(GSSnew, aes(x= sexeduc,  group=marital2)) + 
                  geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") +
                  geom_text(aes( label = scales::percent(..prop..),
                                 y= ..prop.. ), stat= "count", vjust = -.5) +
                  labs(y = "Percent", fill="sexeduc") +
                  facet_grid(~marital2) +
                  scale_y_continuous(labels = scales::percent)

##Region 
tab <- as.data.frame(table(GSSnew$marital, GSSnew$region))
colnames(tab) <- c("status", "region", "count")
pie_12a <- ggplot(tab, aes(status, region)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Region?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$region))
colnames(tab) <- c("status", "region", "count")
pie_12b <- ggplot(tab, aes(status, region)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Region?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

##Can people be trusted? 
tab <- as.data.frame(table(GSSnew$marital, GSSnew$trust))
colnames(tab) <- c("status", "trust", "count")
pie_13a <- ggplot(tab, aes(status, trust)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Can people be trusted?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$trust))
colnames(tab) <- c("status", "trust", "count")
pie_13b <- ggplot(tab, aes(status, trust)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Can people be trusted?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

      TrustGraph2 <- ggplot(GSSnew, aes(x= trust,  group=marital2)) + 
                        geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") +
                        geom_text(aes( label = scales::percent(..prop..),
                                       y= ..prop.. ), stat= "count", vjust = -.5) +
                        labs(y = "Percent", fill="trust") +
                        facet_grid(~marital2) +
                        scale_y_continuous(labels = scales::percent)

##Region at age 16
tab <- as.data.frame(table(GSSnew$marital, GSSnew$reg16))
colnames(tab) <- c("status", "region16", "count")
pie_20a <- ggplot(tab, aes(status, region16)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Region at age 16?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$reg16))
colnames(tab) <- c("status", "region16", "count")
pie_20b <- ggplot(tab, aes(status, region16)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Region at age 16?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)


##Live with both parents at age 16
tab <- as.data.frame(table(GSSnew$marital, GSSnew$family16))
colnames(tab) <- c("status", "family16", "count")
pie_21a <- ggplot(tab, aes(status, family16)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Live with both parents at age 16?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$family16))
colnames(tab) <- c("status", "family16", "count")
pie_21b <- ggplot(tab, aes(status, family16)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Live with both parents at age 16?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)


##If not with parents, why?
tab <- as.data.frame(table(GSSnew$marital, GSSnew$famdif16))
colnames(tab) <- c("status", "familyif16", "count")
pie_1 <- ggplot(tab, aes(status, familyif16)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("If not with both parents, why?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

        ParentsGraph2 <- ggplot(GSSnew, aes(x= famdif16,  group=marital2)) + 
                                geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") +
                                geom_text(aes( label = scales::percent(..prop..),
                                               y= ..prop.. ), stat= "count", vjust = -.5) +
                                labs(y = "Percent", fill="family") +
                                facet_grid(~marital2) +
                                scale_y_continuous(labels = scales::percent)

#### Experimenting with Plotting Relative Percentages 
GSSnew$class2 <- "blank"
GSSnew$class2 [GSSnew$class == "NO CLASS"] <- "NO CLASS"
GSSnew$class2 [GSSnew$class == "UPPER CLASS"] <- "UPPER CLASS"
GSSnew$class2 [GSSnew$class == "MIDDLE CLASS"] <- "MIDDLE CLASS"
GSSnew$class2 [GSSnew$class == "WORKING CLASS"] <- "WORKING CLASS"
GSSnew$class2 [GSSnew$class == "LOWER CLASS"] <- "LOWER CLASS"
GSSnew$class2 [is.na(GSSnew$class) ==T] <- NA

ClassGraph <- ggplot(GSSnew, aes(class2, group = marital2)) + 
          geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") + 
          scale_y_continuous(labels=scales::percent) +
          ylab("relative frequencies") +
          facet_grid(~marital2)

ClassGraphPerc <- ggplot(GSSnew, aes(x= class2,  group=marital2)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="class2") +
    facet_grid(~marital2) +
    scale_y_continuous(labels = scales::percent)

ClassGraph2 <- ggplot(GSSnew, aes(x= class,  group=marital2)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="class") +
    facet_grid(~marital2) +
    scale_y_continuous(labels = scales::percent)
## http://www.r-graph-gallery.com/48-grouped-barplot-with-ggplot2/
```

### Step Three: Split data by ballot and into train-validate-test groups

``` {r splits, include=FALSE, cache=TRUE }
## Separate GSSnew by ballot type A, B or C

GSS.A <- subset(GSSnew, (GSSnew$version==1|GSSnew$version==4))
clusters.vars.A <- c("year", "sexeduc", "region", "premarsx", "xmarsex", "partyid", "fund", "childs",  "degree", "Agecat1", "widowed", "wrkstat", "polviews", "happy", "class",  "reg16", "family16", "born", "parborn", "income", "sizecat", "attend", "relig16", "bible", "satjob", "satfin", "abnomore", "absingle", "divlaw", "marital2")
GSS.A <- GSS.A[,clusters.vars.A]
GSS.A <- GSS.A[complete.cases(GSS.A),]
GSS.B <- subset(GSSnew, (GSSnew$version==2|GSSnew$version==5))
GSS.C <- subset(GSSnew, (GSSnew$version==3|GSSnew$version==6))

## Train-validate-test split for GSS Ballot A
set.seed(567)
rand <- runif(nrow(GSS.A))

trainA <- GSS.A[rand>0.3,]
validA <- GSS.A[rand>0.15 & rand <0.3,]
testA <- GSS.A[rand<0.15,]

## Train-validate-test split for GSS Ballot B
set.seed(678)
rand <- runif(nrow(GSS.B))

trainB <- GSS.B[rand>0.3,]
validB <- GSS.B[rand>0.15 & rand <0.3,]
testB <- GSS.B[rand<0.15,]

## Train-validate-test split for GSS Ballot B
set.seed(789)
rand <- runif(nrow(GSS.C))

trainC <- GSS.C[rand>0.3,]
validC <- GSS.C[rand>0.15 & rand <0.3,]
testC <- GSS.C[rand<0.15,]
```


### Step Four: Analysis, logistic regression
``` {r logit, include=FALSE, cache=TRUE}
###Logistic Regression 
#glm(marital2 ~ <x>, data = <data>, family = binomial())
fitA <- glm(marital2 ~ year + sexeduc + region + premarsx + xmarsex + partyid + fund + childs + degree + Agecat1 + widowed + wrkstat + polviews + happy + class + income + reg16 + family16 + born + parborn + sizecat + attend + relig16 + bible + satjob + satfin + abnomore + absingle + divlaw, family=binomial(link='logit'),data=trainA) 
summary(fitA)
trainA$pred <- fitA$fitted.values
trainA$pred <- ifelse(trainA$pred > 0.5,1,0)
table(trainA$marital2, trainA$pred)
validA$pred <- predict(fitA, newdata = validA, type = "response")
validA$pred <- ifelse(validA$pred > 0.5,1,0)
table(validA$marital2, validA$pred)
fitA2 <- glm(marital2 ~ year + region + childs + degree + Agecat1 + widowed + wrkstat + class + income +  family16 + born + parborn + sizecat, family=binomial(link='logit'),data=trainA) 
trainA$pred2 <- fitA2$fitted.values
trainA$pred2 <- ifelse(trainA$pred2 > 0.5,1,0)
table(trainA$marital2, trainA$pred2)
validA$pred2 <- predict(fitA2, newdata = validA, type = "response")
validA$pred2 <- ifelse(validA$pred2 > 0.5,1,0)
table(validA$marital2, validA$pred2)


fitB <- glm(marital2 ~ year + sexeduc + region + premarsx + pornlaw + partyid + fund + childs + degree + Agecat1 + widowed + wrkstat + polviews + happy + trust + class + income + reg16 + family16 + born + parborn + size + attend + relig16 + bible + helpful + fair + consci + satjob + satfin + xmovie + divlaw + fefam, family=binomial(link='logit'),data=trainB) 
summary(fitB)

fitC <- glm(marital2 ~ year + region + premarsx + pornlaw + partyid + fund + childs + degree + Agecat1 + widowed + wrkstat + polviews + happy + trust + class + income + reg16 + family16 + born + parborn + size + attend + relig16 + bible + helpful + fair + consci + satjob + satfin + xmovie + divlaw, family=binomial(link='logit'),data=trainB) 
summary(fitC)


```

Original      | predicted marriage | predicted split
--------------|--------------------|----------------
married       | 1331               | 78
split         | 368                | 162

### Step Five: Analysis, decision trees
``` {r trees}



```

### Step Six: Analysis, clusters
```{r cluster setup, include=FALSE, cache = TRUE }
#using packages factoextra and NbClust and Cluster
library(factoextra)
library(NbClust)
library(cluster)

# set necessary variables for cluster analysis
clusters.train.a <- GSS.A[,clusters.vars.A]
clusters.train.a <- clusters.train.a[complete.cases(clusters.train.a),]

gss.a.mat <- model.matrix(~0 + year + sexeduc + region + premarsx + xmarsex + partyid + fund + childs + degree + Agecat1 + widowed + wrkstat + polviews + happy + class + income + reg16 + family16 + born + parborn + sizecat + attend + relig16 + bible + satjob + satfin + abnomore + absingle + divlaw, clusters.train.a)

# now with B ballot
clusters.vars.B <- c("year", "sexeduc", "region", "premarsx", "pornlaw", "partyid", "fund", "childs",  "degree", "Agecat1", "widowed", "wrkstat", "polviews", "happy", "trust", "class",  "reg16", "family16", "born", "parborn", "income", "sizecat", "attend", "relig16", "bible", "helpful", "fair", "consci", "satjob", "satfin", "xmovie", "fefam", "divlaw", "marital2")
clusters.b <- GSS.B[,clusters.vars.B]
clusters.b <- clusters.b[complete.cases(clusters.b),]

gss.b.mat <- model.matrix(~0 + year + sexeduc + region + premarsx + pornlaw + partyid + fund + childs + degree + Agecat1 + widowed + wrkstat + polviews + happy + trust + class + income + reg16 + family16 + born + parborn + sizecat + attend + relig16 + bible + helpful + fair + consci + satjob + satfin + xmovie + divlaw + fefam, clusters.b)

# now with Ballot C
clusters.vars.C <- c("year", "region", "xmarsex", "pornlaw", "partyid", "fund", "childs",  "degree", "Agecat1", "widowed", "wrkstat", "polviews", "happy", "trust", "class", "reg16", "family16", "born", "parborn", "income", "fair", "helpful", "sizecat", "attend", "relig16", "bible", "consci", "satjob", "satfin", "abnomore", "absingle", "xmovie", "marital2")
clusters.c <- GSS.C[,clusters.vars.C]
clusters.c <- clusters.c[complete.cases(clusters.c),]

gss.c.mat <- model.matrix(~0 + year + region + xmarsex + pornlaw + partyid + fund + childs + degree + Agecat1 + widowed + wrkstat + polviews + happy + trust + class + income + reg16 + family16 + born + parborn + sizecat + attend + relig16 + bible + helpful + fair + consci + satjob + satfin + abnomore + absingle + xmovie, clusters.c)
```
``` {r cluster A, include=FALSE, cache=TRUE}
#determine optimal number of clusters using method within-cluster sum of squares
# visualize as line ("elbow" method)
elbow.a <- fviz_nbclust(gss.a.mat, kmeans, method = "wss") 
# (silhouette method)
sil.plot.a <- fviz_nbclust(gss.a.mat, kmeans, method = "silhouette") 
  # optimal cluster is 2! 
# compute kmeans clusters
km.a <- kmeans(gss.a.mat, 2, 10)
# compute hierarchical clusters and check silhouette for validation 
hc.a <- eclust(gss.a.mat, "hclust", k=2, method="ward.D2", graph=FALSE)
sil.a <- hc.a$silinfo
sil.a$clus.avg.widths
  # not very good  ~0.45
# compute PAM clusters
pam.a <- pam(gss.a.mat, 2)
# visulize as silhouette plot
fviz_silhouette(pam.a)
  # similar to hierarchical

#compare clusters to marital status
table(clusters.train.a$marital2, km.a$cluster)
table(clusters.train.a$marital2, hc.a$cluster)
table(clusters.train.a$marital2, pam.a$cluster)
```
```{r cluster output A, echo=FALSE, warning=FALSE, message=FALSE}
grid.arrange(elbow.a, sil.plot.a, ncol=2)
```
```{r cluster B and C, include=FALSE, cache=TRUE}
#determine optimal number of clusters using method within-cluster sum of squares
# visualize as line ("elbow" method)
elbow.b <- fviz_nbclust(gss.b.mat, kmeans, method = "wss") 
# (silhouette method)
sil.plot.b <- fviz_nbclust(gss.b.mat, kmeans, method = "silhouette") 
  # optimal cluster is 2! 
# compute kmeans clusters
km.b <- kmeans(gss.b.mat, 2, 10)
#ksil.a <- silhouette(km.a$cluster, dist(diss.a))
#head(ksil.a)
# compute hierarchical clusters and check silhouette for validation 
hc.b <- eclust(gss.b.mat, "hclust", k=2, method="complete", graph=FALSE)
sil.b <- hc.b$silinfo
sil.b$clus.avg.widths
  # not very good  ~0.47/~0.38

# compute PAM clusters
pam.b <- pam(gss.b.mat, 2)
# visulize as silhouette plot
fviz_silhouette(pam.b)
  # similar to hierarchical

#compare clusters to marital status
table(clusters.b$marital2, km.b$cluster)
table(clusters.b$marital2, hc.b$cluster)
table(clusters.b$marital2, pam.b$cluster)


#determine optimal number of clusters using method within-cluster sum of squares
# visualize as line ("elbow" method)
fviz_nbclust(gss.c.mat, kmeans, method = "wss") 
# (silhouette method)
fviz_nbclust(gss.c.mat, kmeans, method = "silhouette") 
  # optimal cluster is 2! 
# compute kmeans clusters
km.c <- kmeans(gss.c.mat, 2, 10)
#ksil.a <- silhouette(km.a$cluster, dist(diss.a))
#head(ksil.a)
# compute hierarchical clusters and check silhouette for validation 
hc.c <- eclust(gss.c.mat, "hclust", k=2, method="complete", graph=FALSE)
sil.c <- hc.c$silinfo
sil.c$clus.avg.widths
  # not very good  ~0.28/~0.41

# compute PAM clusters
pam.c <- pam(gss.c.mat, 2)
# visulize as silhouette plot
fviz_silhouette(pam.c)
  # similar to hierarchical

#compare clusters to marital status
table(clusters.b$marital2, km.b$cluster)
table(clusters.b$marital2, hc.b$cluster)
table(clusters.b$marital2, pam.b$cluster)
```
