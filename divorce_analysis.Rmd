---
title: "Divorce Analysis"
author: "SU"
date: "April 15, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r data, include=FALSE}
load("GSSdivorce.rda")
```

### Step One: Check for missing data
```{r missing, echo=FALSE}



```

### Step Two: Visually check distributions of variable responses

```{r visuals, echo=FALSE}
library(ggplot2)
library(plyr)

##Opinion on Premarital Sex 
#Married vs Divorced vs Separated vs Other
tab <- as.data.frame(table(GSSnew$marital, GSSnew$premarsx))
colnames(tab) <- c("status", "premarital", "count")
pie_1a <- ggplot(tab, aes(status, premarital)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Opinion on premarital sex?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$premarsx))
colnames(tab) <- c("status", "premarital", "count")
pie_1b <- ggplot(tab, aes(status, premarital)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Opinion on premarital sex?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

##Opinion on Pornography Laws
tab <- as.data.frame(table(GSSnew$marital, GSSnew$pornlaw))
colnames(tab) <- c("status", "porn", "count")
pie_2a <- ggplot(tab, aes(status, porn)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Opinion on pornography regulation?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$pornlaw))
colnames(tab) <- c("status", "porn", "count")
pie_2b <- ggplot(tab, aes(status, porn)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Opinion on pornography regulation?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

##Opinion on Extramarital Sex 
tab <- as.data.frame(table(GSSnew$marital, GSSnew$xmarsex))
colnames(tab) <- c("status", "exmar", "count")
pie_3a <- ggplot(tab, aes(status, exmar)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Opinion on extramarital sex?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$xmarsex))
colnames(tab) <- c("status", "exmar", "count")
pie_3b <- ggplot(tab, aes(status, exmar)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Opinion on extramarital sex?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

##Party Identification 
tab <- as.data.frame(table(GSSnew$marital, GSSnew$partyid))
colnames(tab) <- c("status", "party", "count")
pie_4a <- ggplot(tab, aes(status, party)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Party identification?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$partyid))
colnames(tab) <- c("status", "party", "count")
pie_4b <- ggplot(tab, aes(status, party)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Party identification?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

##How happy are you? 
tab <- as.data.frame(table(GSSnew$marital, GSSnew$happy))
colnames(tab) <- c("status", "happy", "count")
pie_5a <- ggplot(tab, aes(status, happy)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("How happy are you?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$happy))
colnames(tab) <- c("status", "happy", "count")
pie_5b <- ggplot(tab, aes(status, happy)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("How happy are you?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

##Fundamentalism of Religion 
tab <- as.data.frame(table(GSSnew$marital, GSSnew$fund))
colnames(tab) <- c("status", "fund", "count")
pie_6a <- ggplot(tab, aes(status, fund)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Fundamentalism of religion?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$fund))
colnames(tab) <- c("status", "fund", "count")
pie_6b <- ggplot(tab, aes(status, fund)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Fundamentalism of religion?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

##Self-Identified Class
tab <- as.data.frame(table(GSSnew$marital, GSSnew$class))
colnames(tab) <- c("status", "class", "count")
pie_7a <- ggplot(tab, aes(status, class)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Self-identified class?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$class))
colnames(tab) <- c("status", "class", "count")
pie_7b <- ggplot(tab, aes(status, class)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Self-identified class?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

##Work Status
tab <- as.data.frame(table(GSSnew$marital, GSSnew$wrkstat))
colnames(tab) <- c("status", "work", "count")
pie_8a <- ggplot(tab, aes(status, work)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Work status?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$wrkstat))
colnames(tab) <- c("status", "work", "count")
pie_8b <- ggplot(tab, aes(status, work)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Work status?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)


##Years of Education 
tab <- as.data.frame(table(GSSnew$marital, GSSnew$educ))
colnames(tab) <- c("status", "edu", "count")
pie_9a <- ggplot(tab, aes(status, edu)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Years of education?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$educ))
colnames(tab) <- c("status", "edu", "count")
pie_9b <- ggplot(tab, aes(status, edu)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Years of education?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

      ###Histogram
        EducGraph2 <- ggplot(GSSnew, aes(x= educ,  group=marital2)) + 
            geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") +
            geom_text(aes( label = scales::percent(..prop..),
                           y= ..prop.. ), stat= "count", vjust = -.5) +
            labs(y = "Percent", fill="educ") +
            facet_grid(~marital2) +
            scale_y_continuous(labels = scales::percent)

##Children 
tab <- as.data.frame(table(GSSnew$marital, GSSnew$childs))
colnames(tab) <- c("status", "child", "count")
pie_10a <- ggplot(tab, aes(status, child)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Children?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$childs))
colnames(tab) <- c("status", "child", "count")
pie_10b <- ggplot(tab, aes(status, child)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Children?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)


#Sex Education in Schools
tab <- as.data.frame(table(GSSnew$marital, GSSnew$sexeduc))
colnames(tab) <- c("status", "sexed", "count")
pie_11a <- ggplot(tab, aes(status, sexed)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Sex education in schools?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$sexeduc))
colnames(tab) <- c("status", "sexed", "count")
pie_11b <- ggplot(tab, aes(status, sexed)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Sex education in schools?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

       SexEducGraph2 <- ggplot(GSSnew, aes(x= sexeduc,  group=marital2)) + 
                  geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") +
                  geom_text(aes( label = scales::percent(..prop..),
                                 y= ..prop.. ), stat= "count", vjust = -.5) +
                  labs(y = "Percent", fill="sexeduc") +
                  facet_grid(~marital2) +
                  scale_y_continuous(labels = scales::percent)

##Region 
tab <- as.data.frame(table(GSSnew$marital, GSSnew$region))
colnames(tab) <- c("status", "region", "count")
pie_12a <- ggplot(tab, aes(status, region)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Region?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$region))
colnames(tab) <- c("status", "region", "count")
pie_12b <- ggplot(tab, aes(status, region)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Region?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

##Can people be trusted? 
tab <- as.data.frame(table(GSSnew$marital, GSSnew$trust))
colnames(tab) <- c("status", "trust", "count")
pie_13a <- ggplot(tab, aes(status, trust)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Can people be trusted?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$trust))
colnames(tab) <- c("status", "trust", "count")
pie_13b <- ggplot(tab, aes(status, trust)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Can people be trusted?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

      TrustGraph2 <- ggplot(GSSnew, aes(x= trust,  group=marital2)) + 
                        geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") +
                        geom_text(aes( label = scales::percent(..prop..),
                                       y= ..prop.. ), stat= "count", vjust = -.5) +
                        labs(y = "Percent", fill="trust") +
                        facet_grid(~marital2) +
                        scale_y_continuous(labels = scales::percent)

##Region at age 16
tab <- as.data.frame(table(GSSnew$marital, GSSnew$reg16))
colnames(tab) <- c("status", "region16", "count")
pie_20a <- ggplot(tab, aes(status, region16)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Region at age 16?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$reg16))
colnames(tab) <- c("status", "region16", "count")
pie_20b <- ggplot(tab, aes(status, region16)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Region at age 16?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)


##Live with both parents at age 16
tab <- as.data.frame(table(GSSnew$marital, GSSnew$family16))
colnames(tab) <- c("status", "family16", "count")
pie_21a <- ggplot(tab, aes(status, family16)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Live with both parents at age 16?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

tab <- as.data.frame(table(GSSnew$marital2, GSSnew$family16))
colnames(tab) <- c("status", "family16", "count")
pie_21b <- ggplot(tab, aes(status, family16)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("Live with both parents at age 16?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)


##If not with parents, why?
tab <- as.data.frame(table(GSSnew$marital, GSSnew$famdif16))
colnames(tab) <- c("status", "familyif16", "count")
pie_1 <- ggplot(tab, aes(status, familyif16)) + 
              geom_point(aes(size = count), colour = "green") + 
              theme_bw() + xlab("Marital Status?") + ylab("If not with both parents, why?") + scale_size_continuous(range=c(3,15)) + theme(plot.title = element_text(size = 10), legend.position="none")  + coord_fixed(ratio = 1)

        ParentsGraph2 <- ggplot(GSSnew, aes(x= famdif16,  group=marital2)) + 
                                geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") +
                                geom_text(aes( label = scales::percent(..prop..),
                                               y= ..prop.. ), stat= "count", vjust = -.5) +
                                labs(y = "Percent", fill="family") +
                                facet_grid(~marital2) +
                                scale_y_continuous(labels = scales::percent)

#### Experimenting with Plotting Relative Percentages 
GSSnew$class2 <- "blank"
GSSnew$class2 [GSSnew$class == "NO CLASS"] <- "NO CLASS"
GSSnew$class2 [GSSnew$class == "UPPER CLASS"] <- "UPPER CLASS"
GSSnew$class2 [GSSnew$class == "MIDDLE CLASS"] <- "MIDDLE CLASS"
GSSnew$class2 [GSSnew$class == "WORKING CLASS"] <- "WORKING CLASS"
GSSnew$class2 [GSSnew$class == "LOWER CLASS"] <- "LOWER CLASS"
GSSnew$class2 [is.na(GSSnew$class) ==T] <- NA

ClassGraph <- ggplot(GSSnew, aes(class2, group = marital2)) + 
          geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") + 
          scale_y_continuous(labels=scales::percent) +
          ylab("relative frequencies") +
          facet_grid(~marital2)

ClassGraphPerc <- ggplot(GSSnew, aes(x= class2,  group=marital2)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="class2") +
    facet_grid(~marital2) +
    scale_y_continuous(labels = scales::percent)

ClassGraph2 <- ggplot(GSSnew, aes(x= class,  group=marital2)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="class") +
    facet_grid(~marital2) +
    scale_y_continuous(labels = scales::percent)
## http://www.r-graph-gallery.com/48-grouped-barplot-with-ggplot2/
```

### Step Three: Split data by ballot and into train-validate-test groups

``` {r splits}
## Separate GSSnew by ballot type A, B or C

GSS.A <- subset(GSSnew, (GSSnew$version==1|GSSnew$version==4))
GSS.B <- subset(GSSnew, (GSSnew$version==2|GSSnew$version==5))
GSS.C <- subset(GSSnew, (GSSnew$version==3|GSSnew$version==6))

## Train-validate-test split for GSS Ballot A
set.seed(567)
rand <- runif(nrow(GSS.A))

trainA <- GSS.A[rand>0.3,]
validA <- GSS.A[rand>0.15 & rand <0.3,]
testA <- GSS.A[rand<0.15,]

## Train-validate-test split for GSS Ballot B
set.seed(678)
rand <- runif(nrow(GSS.B))

trainB <- GSS.B[rand>0.3,]
validB <- GSS.B[rand>0.15 & rand <0.3,]
testB <- GSS.B[rand<0.15,]

## Train-validate-test split for GSS Ballot B
set.seed(789)
rand <- runif(nrow(GSS.C))

trainC <- GSS.C[rand>0.3,]
validC <- GSS.C[rand>0.15 & rand <0.3,]
testC <- GSS.C[rand<0.15,]
```


# Step Four: Analysis, logistic regression
``` {r logit}
###Logistic Regression 
#glm(marital2 ~ <x>, data = <data>, family = binomial())
fitA <- glm(marital2 ~ year + sexeduc + region + premarsx + xmarsex + partyid + fund + childs + degree + Agecat1 + widowed + wrkstat + polviews + happy + class + income98 + reg16 + family16 + born + parborn + size + attend + relig16 + bible + satfin + abnomore + absingle + divlaw + fefam, family=binomial(link='logit'),data=trainA) 
#data = dfTraining, family = binomial())
summary(fitA)

  

```

# Step Five: Analysis, decision trees
``` {r trees}



```

# Step Six: Analysis, clusters
```{r clusters}
clusters.vars.A <- c("year", "sexeduc", "region", "premarsx", "xmarsex", "partyid", "fund", "childs",  "degree", "Agecat1", "widowed", "educ", "wrkstat", "polviews", "happy", "trust", "class",    "reg16", "family16", "famdif16", "born", "parborn", "income98", "size", "attend", "relig16", "bible",    "satfin", "abnomore", "absingle", "divlaw", "fefam", "marital2")
clusters.train.a <- trainA[,clusters.vars.A]

dist.mat.A <- dist(clusters.train.a, method = "euclidean")
clusters.a <- hclust(dist.mat.A)
tree.a <- cutree(clusters.a, k=2)
table(tree.a)
plot(cut(as.dendrogram(clusters.a), h=2000)$upper, leaflab="none")
dist.mat.A2 <- dist(clusters.train.a, method = "manhattan")
clusters.a2 <- hclust(dist.mat.A2)
tree.a2 <- cutree(clusters.a2, k=2)
table(tree.a2)
plot(cut(as.dendrogram(clusters.a2), h=2000)$upper, leaflab="none")
dist.mat.A3 <- dist(clusters.train.a, method = "maximum")
clusters.a3 <- hclust(dist.mat.A3)
tree.a3 <- cutree(clusters.a3, k=2)
table(tree.a3)
plot(cut(as.dendrogram(clusters.a3), h=0)$upper, leaflab="none")

```
